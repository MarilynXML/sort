<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>React 基础学习</title>
		<script src="script/JSXTransformer.js"></script>
		<!-- <script src="script/react.js"></script> -->
		<script src="script/react-with-addons.js"></script>
		<script src="libs/showdown/dist/showdown.js"></script>
		<link rel="stylesheet" href="libs/bootstrap/dist/css/bootstrap.min.css">
		<style>
			.container{
				width:1040px;
				line-height: 1.5;
				margin:0 auto;
				background-color: #f5f5f5;
				padding:1em;
			}
			.container>p{
				font-size:1.4em;
			}
			.form-horizontal{
				overflow:hidden;
			}
			textarea.form-control{
				resize:none;
			}
			.text-comment{
				margin-left:40px;
				padding-top:4px;
			}
			.comment-item{
				padding:5px 0;
				padding-right:86px;
			}
			.vote{
				position:relative;
				height:48px;
				line-height:48px;
				width:36px;
				text-align:center;
				float:left;
			}
			button.btn.like:focus,button.btn.like:active{
				outline:none;
			}
			.like,.unlike{
				position:absolute;
				background:transparent url(vote-bg@2x.png) no-repeat;
				background-size:auto 54px;
				padding:8px 18px;
				cursor:pointer;
			}
			.like{
				background-position:0 0;
				top:0;
				left:0;
			}
			.like:hover{
				background-position:-36px 0;
			}
			.unlike{
				left:0;
				bottom:0;
				background-position:0 bottom;
			}
			.unlike:hover{
				background-position:-36px bottom;
			}
			.text-overflow{
				display:block;
				white-space:nowrap;
				text-overflow:ellipsis;
				overflow:hidden;
			}
			.comment-add-enter{
				opacity:0.01;
				transition:opacity 1.2s linear;
			}
			.comment-add-enter.comment-add-enter-active{
				opacity:1;
			}
			.comment-add-leave{
				opacity:1;
				transition:opacity 1.2s linear;
			}
			.comment-add-leave.comment-add-leave-active{
				opacity:0.01;
			}
			.close{
				background-color:#f5f5f5;
				border:none;
				float:right;
				font-size：larger;
			}
		</style>
	</head>
	<body>
		<button id="full">全屏</button>
		<h1>React 学习测试</h1>
		<div class="container">
			<div class="hello-world">
				<p>这个是要被替换了的</p>
			</div>
			<div class="comment-container"></div>
			<div class="lists"></div>
		</div>
		<script>
			function func(e){
				alert('test');
				e.preventDefault();
				console.log('submit called');
			}
			document.getElementById('full').addEventListener('click',
				function(){
					var docElm = document.documentElement;
		if (docElm.requestFullscreen) {
		docElm.requestFullscreen();
		}
		else if (docElm.msRequestFullscreen) {
		docElm.msRequestFullscreen();
		}
		else if (docElm.mozRequestFullScreen) {
		docElm.mozRequestFullScreen();
		}
		else if (docElm.webkitRequestFullScreen) {
		docElm.webkitRequestFullScreen();
		}
		}, false);
			
		</script>
		<script type="text/jsx">
			var Perf = React.addons.Perf;
			Perf.start();
			var HelloWorld = React.createClass({
				statics:{
					funcStatic:function(){
						console.log('我是HelloWorld上的静态方法');
					}
				},
				getDefaultProps:function(){
					console.log('getDefaultProps:',arguments);
					return {text:'default props text'};
				},
				getInitialState:function(){
					return {status:'start'};
				},
				componentWillReceiveProps:function(){
					console.log('receiveProps:',arguments);
				},
				componentWillUpdate:function(){
					console.log('update:',arguments);
				},
				// shouldComponentUpdate:function(){
						// 	console.log('shouldUpdate:',arguments);
						// 	return true;
				// },
				componentDidMount:function(){
					console.log('componentDidMount',arguments);
				},
				onHandleClick:function(data,evt){
					console.log(temp=this);
					console.log('data:',data);
					this.constructor.funcStatic();
				},
				render:function(){
					return (<p onClick={this.onHandleClick.bind(this,{name:'lds'})} className="lead">{this.props.text}</p>);
				}
			});
			React.render(
				<HelloWorld text = "输入评论：" />,
				document.querySelector('.hello-world')
			);
			var ListItem = React.createClass({
				getInitialState:function(){
					return {times:0};
				},
				getDefaultProps:function(){
					return {text:''};
				},
				componentWillUnmount:function(){
					console.log('listItem-componentWillUnmount');
				},
				shouldComponentUpdate:function(){
					console.log('shouldComponentUpdate',arguments);
					return true;
				},
				onHandleClick:function(evt){
					console.log(evt);
					switch(evt.target.className){
						case 'like':
							this.setState({times:++this.state.times});
							break;
						case 'unlike':
							this.setState({times:--this.state.times>0 ? this.state.times:0});
							break;
						default:
							break;
					}
					console.log(window.listItem = this);
				},
				removeComment:function(evt){
					var index,
						domNode = this.getDOMNode(),
						parentElementChildren = domNode.parentElement.children;
					for(var i=0;i<parentElementChildren.length;i++){
						if(domNode===parentElementChildren[i]){
							index=i;
							console.log('this is for deleted index',index);
							this.props.removeComment(index);
							break;
						}
					}
					// console.log(evt.currentTarget);
					// var comment = evt.currentTarget.parentElement;
					// comment.parentElement.removeChild(comment);
				},
				render:function(){
					return (
							<li key={this.props.key} className="comment-item clearfix">
								<button type="button" className="close remove" data-dismiss="modal" onClick={this.removeComment}><span aria-hidden="true">×</span><span className="sr-only">Close</span></button>
								<div className="vote" onClick={this.onHandleClick}>
									<span className="like"><span className="sr-only">支持一下</span></span>
									<span className="text-overflow">{this.state.times}</span>
									<span className="unlike"><span className="sr-only">答案有问题,否决</span></span>
								</div>
								<div className="text-comment" dangerouslySetInnerHTML={{__html:this.props.text}} />
							</li>
							);
				}
			});
			var CommentList = React.createClass({
				propTypes: {
			        list: React.PropTypes.array
			    },
			    getInitialState:function(){
			    	return {
			    		times:0,
			    		another:'another'
			    	};
			    },
				componentWillUpdate:function(nextProps,nextState){
					// console.log('prevProps:',this.props.list.length);
					// console.log('updateProps:',nextProps);
					console.log(window.commentList=this);
					console.log(arguments);
				},
				// shouldComponentUpdate:function(){
				// 	console.log('shouldComponentUpdate',arguments);
				// 	return true;
				// },
				componentWillMount:function(){
					console.log('commentList-componentWillMount');
				},
				componentDidMount:function(){
					console.log('commentList-componentDidMount');
				},
				componentWillReceiveProps:function(nextProp,nextState){
					console.log('commentList-componentWillReceiveProps');
				},
				componentUnMount:function(){
					console.log('unMount:',arguments);
				},
				render:function(){
					var self = this;
					var lists = this.props.list.map(function(val,index){
									return (<ListItem key={'key-'+index} text={val} removeComment={self.props.removeComment} />);
							});
					return (
							<ReactCSSTransitionGroup transitionName="comment-add" component="ul" className="list-unstyled" onClick={this.onHandleClick} >
								{lists}
							</ReactCSSTransitionGroup>
						);
				}
			});
					
			var mixins = {
				test:function(){
					alert('mixins test');
				},
				textareaTab:function(){
					var textarea = document.querySelector('form>textarea');
					textarea.addEventListener('keydown',function(e) {
					    if(e.keyCode === 9) { 
					        var start = this.selectionStart;
					        var end = this.selectionEnd;
					        console.log('start:',start,'end:',end);
					        var value = this.value;
					        this.value = value.substring(0, start)
					                    + "\t"
					                    + value.substring(end);
					        this.selectionStart = this.selectionEnd = start + 1;
					        e.preventDefault();
					    }
					});
					
				}
			};

			var ReactCSSTransitionGroup = React.addons.CSSTransitionGroup;
			var converter = new showdown.Converter();
			var Comments = React.createClass({
				mixins:[mixins,React.addons.LinkedStateMixin],
				getInitialState:function(){
					return {
						comment:''
					};
				},
				componentWillMount:function(){
					this.props.list.forEach(function(item,ind,arr){
						arr[ind] = converter.makeHtml(item);
					});
					console.log(comments=this);
					console.log('Comments will mount called');
				},
				componentDidMount:function(){
					console.log('comments-componentDidMount');
					this.textareaTab();
				},
				handleSubmit:function(evt){
					evt.preventDefault();
					var value = this.refs.textarea.getDOMNode().value;
					if(!value.trim())return;
					this.refs.textarea.getDOMNode().value = '';
					this.setState({comment:''});
					this.props.list.push(converter.makeHtml(value));
					this.setProps({list:this.props.list});
					console.log(window.temp = this);
					console.log(evt);
					Perf.stop();
				},
				removeComment:function(index){
					this.props.list.splice(index,1);
					this.setProps({
						list:this.props.list
					});
				},
				render:function(){
					return (
							<div>
								<form action="" method="post" encType="application/x-www-form-urlencoded" className="form-horizontal clearfix" name='formComment' onSubmit={this.handleSubmit}>
									<textarea valueLink = {this.linkState('comment')} className="form-control" type="text" name="textarea" rows="4" placeholder="input your comment here" ref="textarea"></textarea>
									<input type="submit" name="submit" value ="提交" className="btn btn-primary pull-right" />
								</form>
								<CommentList list = {this.props.list} removeComment = {this.removeComment} />
							</div>
						);
				}
			});
			var commentInfoArr = ['第一个评论','需要控制LikeText的那个state除了通过自身state控制外再加上props控制，LikeButton通过改变LikeText的props来控制，需要用到componentWillReceiveProps，代码参考如下：'];
			React.render(
					<Comments list={commentInfoArr} />,
					document.querySelector('.comment-container')
				);
				// var container = document.querySelector(selector);
				// React.unmountComponentAtNode(container);
			</script>
			<script type="text/jsx">
				parent=React.createElement(ListItem, {key:'key-'+1, text:'value of text'},
							child=React.createElement("div", {className: "vote", onClick: this.onHandleClick}));
			</script>
			<script type="text/jsx">
				var Lists = React.createClass({
					getInitialState:function(){
						var style={
							maxWidth:100,
						};
						return {
							lists:[{
								src:'image/1.jpg',
								href:'index.html',
								title:'images-1',
								style:style
							},
							{
								src:'image/2.jpg',
								href:'http://www.baidu.com',
								title:'images-2',
								style:style
							},
							{
								src:'image/3.jpg',
								href:'http://google.com.hk',
								title:'image-3',
								style:style
							}]
						};
					},
					render:function(){
						var lists = this.state.lists.map(function(item,index){
							return (
								<li><a href={item.href} title={item.title}><Image src={item.src}  style={item.style} /></a></li>
							);
						});
						console.log(lists);
						return(
							<ul>
								{lists}
							</ul>
						);
					}
				});
				var Image = React.createClass({
					render:function(){
						return (
							<img src={this.props.src} style={this.props.style}/>
						);						
					}
				});
				React.render(
					<Lists />,
					document.querySelector('.lists')
				);
			</script>
		</body>
	</html>